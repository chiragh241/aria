# Aria Operator Guide

Quick reference for running and configuring Aria.

## Config and Paths

- **Config file**: `config/settings.yaml` (or `config/settings.local.yaml`). Generated by `python -m src.main --setup`.
- **Data directory**: `./data` by default (`aria.data_dir`). Contains:
  - `conversations/` – persisted chat context per channel/user
  - `workspace/` – SOUL.md, USER.md, IDENTITY.md, AGENTS.md (personality and identity)
  - `pending_skills/` – skills waiting for approval when `skills.learned.require_approval` is true
  - `learned_skills/` – approved and loaded skills
  - `chromadb/` – vector memory
  - `logs/` – app and audit logs
- **Validation**: On load, Aria validates `aria.name` and `llm.local.base_url` when local LLM is enabled. Fix any `ValueError` from config before starting.

## Workspace (Identity and Personality)

- **Files**: `data/workspace/SOUL.md`, `IDENTITY.md`, `USER.md`, `AGENTS.md`. Injected into the system prompt for every conversation.
- **Bootstrap**: First run can auto-fill templates if `workspace.bootstrap_on_first_run` is true. Or run `python -m src.main --bootstrap` for interactive Q&A, or call `POST /api/workspace/bootstrap` with `body.answers`.
- **Edit**: Via API `GET/PUT /api/workspace/{soul|identity|user|agents}` or by editing files under `data/workspace/`. Per-user `USER.md`: `data/workspace/users/<user_id>/USER.md`.
- **Cap**: Total workspace text is capped by `workspace.max_injected_chars` (default 32_768).

## Orchestrator and Tools

- **Tool iterations**: `orchestrator.max_tool_iterations` (default 15) – how many tool-call rounds per user message. Increase for long tasks; expose in Settings UI.
- **Update workspace from chat**: The assistant can call the `update_workspace` tool to append or replace SOUL/USER/IDENTITY/AGENTS from conversation.
- **Sub-agents**: The assistant can delegate work to specialist agents via the `agent.delegate_subagent` tool: pass a `task` and optional `agent_type` (research, coding, data). The sub-agent runs to completion and its output is returned to the main conversation. Enable/disable with `agents.subagents_enabled` in config.
- **Named workflows**: Use `workflow.list_workflows` to see available workflows, then `workflow.run_named_workflow` with a `workflow_id` (e.g. `feature-dev`, `bug-fix`) and `task`. Workflows run steps in a fixed order (e.g. plan → implement → verify) with specialist agents; each step’s output is passed to the next. Bundled workflows live in `config/workflows/*.yaml`; set `skills.builtin.workflow.workflows_dir` to use another directory.
- **Skills**: Built-in skills are in config; learned skills in `data/learned_skills/`. When `skills.learned.require_approval` is true, new skills go to `data/pending_skills/` until approved via `POST /api/skills/pending/{id}/approve` or Settings → Pending skills.

## Health and Observability

- **Health**: `GET /api/health` – returns `{ ok, orchestrator, workspace, vector_memory }`. No auth required; use for load balancers.
- **Audit export**: `GET /api/audit/export?from_date=...&to_date=...&limit=5000` – JSON export of audit log (auth required).
- **Trace**: `GET /api/trace` – recent trace events (chat start/done, etc.) for debugging.
- **Self-healing**: Config under `proactive.self_healing_*`. Run once via `POST /api/self-healing/check`. Status appears in logs.

## Reliability

- **LLM retries**: The router retries on 429/502/503 with exponential backoff (up to 3 attempts).
- **Context overflow**: If the model hits context limits, the user sees a friendly message suggesting a new chat or summarization. Tool results are truncated and retried once when applicable.

## Extensions and reference

| Capability | Aria |
|------------|------|
| **Gmail webhook** | Enable `webhooks.gmail` in config, set token and `deliver_user_id`. POST `/api/webhooks/gmail` with `x-webhook-token` (or `x-gog-token`) and body `{ "message": "..." }` or `{ "messages": [{ "from", "subject", "snippet", "body" }] }`. Delivers to assistant as a user message. |
| **Camera** | `camera` skill: `take_screenshot` (desktop, macOS/Linux) and `take_photo` (local camera when opencv available). Enable in Settings → Skills. |
| **Talk mode** | `POST /api/talk/cycle`: send `transcript` or `audio_base64`; get assistant `text` and optional `tts_base64`. Use with TTS/STT skills for continuous voice loops. |
| **Images & media** | `image` skill (resize, crop, convert); attachment handling and vision in chat. |
| **Audio / voice notes** | `stt` skill (transcribe); `POST /api/talk/cycle` accepts `audio_base64` and runs STT then chat. |
| **Voice call** | `voice_call` skill (Twilio): `initiate_call(to_number, message)`. Configure Twilio and set `twiml_base_url` to your public Aria URL + `/api/voice/twiml`. GET `/api/voice/twiml?message=...` returns TwiML for Twilio to speak. |
| **Sub-agents** | `agent.delegate_subagent`: delegate a task to a specialist (research/coding/data) and get the result. Config: `agents.subagents_enabled`. |
| **Named workflows** | `workflow.list_workflows` then `workflow.run_named_workflow(workflow_id, task)`. Bundled: `feature-dev` (plan → implement → verify), `bug-fix` (triage → investigate → fix → verify). YAML in `config/workflows/`. |

## Quick Commands

- Start: `python -m src.main`
- Setup wizard: `python -m src.main --setup`
- Workspace bootstrap: `python -m src.main --bootstrap`
- Dev (Vite + backend): `python -m src.main --dev`
